<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>集成 引导</title>
</head>
<link rel="stylesheet" href="res/integrate.css">
<body>

<div class="wrap">
    <h1>WebIM 集成引导</h1>

    <div class="guide">
        <div class="steps">
            <h2>1. 准备工作</h2>
            <div class="content">
                <p>架构说明：<a href="http://www.rongcloud.cn/docs/quick_start.html#架构介绍">http://www.rongcloud.cn/docs/quick_start.html#架构介绍</a>
                </p>
                <p>应用服务器必须要处理的有：</p>
                <ol>
                    <li>1. 维护用户信息，群组信息，好友关系，并提供对应接口供集成使用</li>
                    <li>2. 获取并存储token</li>
                    <li>3. 系统消息，通知等</li>
                </ol>

                <p>
                    开发文档 <a href="http://www.rongcloud.cn/docs/server.html">http://www.rongcloud.cn/docs/server.html</a>
                    <br>
                    搭建应用服务器：<a href="https://github.com/sealtalk/sealtalk-server">https://github.com/sealtalk/sealtalk-server</a>
                </p>
            </div>
        </div>

        <div class="steps">
            <h2>2. 自行设计并UI界面</h2>
            <div class="content">
                <p>集成的思路：</p>
                <ol>
                    <li>1. 根据功能选择SDK里对应的API</li>
                    <li>2. 应用服务器提供其他API之外所有的数据和功能支持</li>
                    <li>3. 合并两部分数据，通过模板渲染呈现（为了实时响应数据变化，建议使用双向绑定）</li>
                    <li>4. 注册对应的事件，包括API的方法（比如发送消息等）或者自行实现的业务方法（注册登录等）</li>
                </ol>
                <br>

                <p>SDK的API</p>
                <ol>
                    <li>1. 链接相关</li>
                    <li>2. 收发消息</li>
                    <li>3. 群组相关</li>
                    <li>4. 聊天室相关</li>
                    <li>5. 公众服务相关</li>
                </ol>
                <br>

                <br>
                <p>接下来主要介绍“<a href="">登录</a>”、“<a href="">会话列表</a>”和“<a href="">聊天窗口</a>”的实现</p>
            </div>
        </div>

        <div class="steps">
            <h2>3. 引入SDK，并完成初始化、链接云端</h2>
            <div class="content">
                文档：<a href="http://www.rongcloud.cn/docs/web.html">http://www.rongcloud.cn/docs/web.html</a> <br>
                参考：<a href="https://shuise.github.io/tech-research/web-sdk-test/token-check.html">https://shuise.github.io/tech-research/web-sdk-test/token-check.html</a>
            </div>
        </div>

        <div class="steps">
            <h2>4. 登录的实现</h2>
            <div class="content">
                <p>可以根据业务需要设计用户名和密码规则，具体的流程：</p>
                <ul>
                    <li>1. 应用服务器处理用户的注册及校验，注册成功后，通过应用服务器访问融云服务器获取用户token并存储在应用服务器</li>
                    <li>2. 用户成功登录后，通过应用服务器返回token</li>
                    <li>3. 端上用户使用token链接融云服务器</li>
                    <li>4. 用户的在线状态</li>
                </ul>
                <div class="content">
                    获取Token文档：<a href="http://www.rongcloud.cn/docs/server.html#获取_Token_方法">http://www.rongcloud.cn/docs/server.html#获取_Token_方法</a>
                    <br>
                    使用token链接融云服务器文档：<a href="http://www.rongcloud.cn/docs/web.html#连接服务器">http://www.rongcloud.cn/docs/web.html#连接服务器</a>
<pre>
function login(){
	// app逻辑
}
//注册成功之后 获取token

//用户登录成功后，链接融云服务器
// 初始化。
RongIMClient.init(appKey);
var token = "";

// 连接融云服务器。
RongIMClient.connect(token, {
onSuccess: function(userId) {
  console.log("Login successfully." + userId);
},
onTokenIncorrect: function() {
  console.log('token无效');
},
onError:function(errorCode){
	  var info = '';
	  switch (errorCode) {
		case RongIMLib.ErrorCode.TIMEOUT:
		  info = '超时';
		  break;
		case RongIMLib.ErrorCode.UNKNOWN_ERROR:
		  info = '未知错误';
		  break;
		case RongIMLib.ErrorCode.UNACCEPTABLE_PaROTOCOL_VERSION:
		  info = '不可接受的协议版本';
		  break;
		case RongIMLib.ErrorCode.IDENTIFIER_REJECTED:
		  info = 'appkey不正确';
		  break;
		case RongIMLib.ErrorCode.SERVER_UNAVAILABLE:
		  info = '服务器不可用';
		  break;
	  }
	  console.log(errorCode);
	}
});
</pre>
                </div>
            </div>
        </div>

        <div class="steps">
            <h2>4. 好友关系，群组</h2>
            <div class="content">
                <p>在应用服务器维护数据，并同步至融云：</p>
                <p>文档：<a href="http://www.rongcloud.cn/docs/server.html">http://www.rongcloud.cn/docs/server.html</a>
                </p>
                <ul>
                    <li>1. 添加好友</li>
                    <li>2. 创建并加入群组</li>
                    <li>3. 禁言及黑名单</li>
                    <li>4. 无用户身份处理</li>
                </ul>
                <pre>code todo</pre>
            </div>
        </div>

        <div class="steps">
            <h2>6. 会话列表的实现</h2>
            <div class="content">
                文档：<a href="http://www.rongcloud.cn/docs/web.html#同步会话列表">http://www.rongcloud.cn/docs/web.html#同步会话列表</a>
                （请注意一定要开启 历史消息云存储功能） <br>
                参考：<a href="https://shuise.github.io/tech-research/web-sdk-test/web-sdk-test.html">https://shuise.github.io/tech-research/web-sdk-test/web-sdk-test.html</a>
                <p>
                    会话列表的数据分两部分，<br>一部分是会话列表（包含最后一条消息），SDK提供了 getConversationList方法获取数据； <br>
                    另外一部分是会话对象（联系人，群等）的基本信息，需要应用服务器提供接口
                </p>
                <pre>var conversation = [
	{
		"conversationTitle": "",
		"conversationType": 1,
		"latestMessage": {
			"content": {
				"messageName": "TextMessage",
				"content": "hello message content",
				"extra": "RongCloud"
			},
			"conversationType": 1,
			"objectName": "RC:TxtMsg",
			"messageDirection": 1,
			"messageId": "1_15814",
			"receivedStatus": 0,
			"receivedTime": 1489567579394,
			"senderUserId": "user8",	//此id对应发送者
			"sentTime": 1489566164555,
			"targetId": "user9",
			"messageType": "TextMessage",
			"messageUId": "5DD2-3V69-C43A-D3EE",
			"offLineMessage": true
		},
		"latestMessageId": "1_15814",
		"notificationStatus": 0,
		"receivedStatus": 0,
		"receivedTime": 1489567579395,
		"sentTime": 1489566164555,
		"targetId": "user9",
		"unreadMessageCount": 0
	}
];

//实际项目里应该从应用服务器获取，群组信息同理
var userInfos = {
	"user8" : {
		"avatar" : "http://rongcloud.cn/images/newVersion/log_wx.png",
		"name" : "John",
		"other props" : ""
	}
};

conversation.forEach(function(item){
	item["userInfo"] = userInfos[item.latestMessage.senderUserId]
});
</pre>
            </div>
        </div>

        <div class="steps">
            <h2>7. 聊天窗口的实现</h2>
            <div class="content">
                <p>聊天窗口由两部分组成，历史消息的列表以及发送消息的窗口，SDK提供了两个对应的方法，getHistroyMessages，sendMessage，消息旁的用户信息与会话列表处理方式一致</p>

                获取历史消息： <a href="http://www.rongcloud.cn/docs/web.html#获取历史消息">http://www.rongcloud.cn/docs/web.html#获取历史消息</a>
                <br>
                发送消息：<a href="http://www.rongcloud.cn/docs/web.html#发送消息">http://www.rongcloud.cn/docs/web.html#发送消息</a>
<pre>
//获取历史消息
RongIMClient.getInstance().getHistoryMessages(conversationtype, targetId, null, 20, {
		onSuccess: function (list, hasMsg) {
				list.length && renderHistoryMessages(list, hasMsg);
				// hasMsg为boolean值，如果为true则表示还有剩余历史消息可拉取，为false的话表示没有剩余历史消息可供拉取。
				// list 为拉取到的历史消息列表
				// renderHistoryMessages 为自定义的渲染页面方法
		},
		onError: function (error) {
				console.log('获取历史消息error' + error);
				// APP未开启消息漫游或处理异常
				// throw new ERROR ......
		}
});

//发送消息
RongIMClient.getInstance().sendMessage(conversationtype, targetId, msg, {
	 // 发送消息成功
	 onSuccess: function (message) {
			 //message 为发送的消息对象并且包含服务器返回的消息唯一Id和发送消息时间戳
			 console.log("Send successfully");
	 },
	 onError: function (errorCode,message) {
			 var info = '';
			 switch (errorCode) {
					 case RongIMLib.ErrorCode.TIMEOUT:
							 info = '超时';
							 break;
					 case RongIMLib.ErrorCode.UNKNOWN_ERROR:
							 info = '未知错误';
							 break;
					 case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:
							 info = '在黑名单中，无法向对方发送消息';
							 break;
					 case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:
							 info = '不在讨论组中';
							 break;
					 case RongIMLib.ErrorCode.NOT_IN_GROUP:
							 info = '不在群组中';
							 break;
					 case RongIMLib.ErrorCode.NOT_IN_CHATROOM:
							 info = '不在聊天室中';
							 break;
					 default :
							 info = x;
							 break;
			 }
			 console.log('发送失败:' + info);
	 }
 });
</pre>
            </div>
        </div>

        <div class="steps">
            <h2>8. 发送消息的功能增强</h2>
            <div class="content">
                <p>图片消息，文件消息，语音消息，地理位置消息，emoji表情及自定义表情，自定义消息</p>
                <p>自动回复，</p>

                发送消息：<a href="http://www.rongcloud.cn/docs/web_api_demo.html#发送消息">http://www.rongcloud.cn/docs/web_api_demo.html#发送消息</a><br>
                语音消息：<a href="http://www.rongcloud.cn/docs/web.html#声音库">http://www.rongcloud.cn/docs/web.html#声音库</a><br>
                表情消息：<a href="http://www.rongcloud.cn/docs/web.html#表情库">http://www.rongcloud.cn/docs/web.html#表情库</a><br>
                自定义消息：<a href="http://www.rongcloud.cn/docs/web_api_demo.html#自定义消息">http://www.rongcloud.cn/docs/web_api_demo.html#自定义消息</a>

            </div>
        </div>
    </div>
</div>


<!--
1：架构说明，收费服务说明，两个链接
		AppServer https://github.com/sealtalk/sealtalk-server
		Server开发文档  http://www.rongcloud.cn/docs/server.html
	2：基本主要的流程
		引入SDK，初始化，监听消息，链接服务器，收发消息，会话，历史消息
	3：所有API的文档和调用示例
		https://shuise.github.io/tech-research/web-sdk-test/web-sdk-test.html
		http://www.rongcloud.cn/docs/api/js/index.html
	4：各种扩展，组件
		表情库 http://www.rongcloud.cn/docs/web.html#表情库
		声音库 http://www.rongcloud.cn/docs/web.html#声音库
		上传组件 http://www.rongcloud.cn/docs/web.html#上传插件
		商量个约定：技术解决方案都叫组件，业务解决方案才叫插件，行么？
	5：各种产品demo，插件
		聊天插件 http://www.rongcloud.cn/docs/web.html#聊天插件
		客服插件 http://www.rongcloud.cn/docs/web.html#客服插件
		VoIP  http://www.rongcloud.cn/docs/web.html#音视频服务
		IM（Web+PC）
-->

</body>
</html>
